-- // СЕРВИСЫ //
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- // ИСПРАВЛЕННАЯ ЗАГРУЗКА БИБЛИОТЕКИ //
-- Используем официальный репозиторий, чтобы избежать ошибок загрузки
local success, WindUI = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/source.lua"))()
end)

if not success or not WindUI then
    warn("Failed to load WindUI library! Check your internet or executor.")
    return
end

-- // НАСТРОЙКИ (CONFIG) //
local Config = {
    -- Aimbot
    AimEnabled = false,
    AimKey = Enum.UserInputType.MouseButton2, -- ПКМ по умолчанию
    AimPart = "Head",
    AimRadius = 150,
    AimSmoothness = 0.5,
    CheckWalls = true,
    CheckTeam = true,
    
    -- Visuals
    FOVEnabled = true,
    FOVColor = Color3.fromRGB(255, 255, 255),
    
    ESPEnabled = false,
    ESPFillColor = Color3.fromRGB(255, 0, 0),
    ESPOutlineColor = Color3.fromRGB(255, 255, 255),
    ESPNames = false
}

-- // ПЕРЕМЕННЫЕ ЛОГИКИ //
-- Используем pcall для Drawing.new на случай, если эксплойт его не поддерживает
local drawingSuccess, FOVCircle = pcall(function()
    local circle = Drawing.new("Circle")
    circle.Thickness = 1.5
    circle.NumSides = 60
    circle.Filled = false
    circle.Transparency = 1
    return circle
end)

if not drawingSuccess then
    warn("Drawing API not supported by your executor. FOV Circle will be disabled.")
    Config.FOVEnabled = false
end

local AimTarget = nil
local ESPContainer = {} 

-- // ФУНКЦИИ ЛОГИКИ //

-- 1. Проверка видимости
local function IsVisible(targetPart)
    if not Config.CheckWalls then return true end
    local origin = Camera.CFrame.Position
    local direction = targetPart.Position - origin
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, targetPart.Parent}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    rayParams.IgnoreWater = true

    local result = Workspace:Raycast(origin, direction, rayParams)
    return result == nil
end

-- 2. Поиск цели
local function GetClosestPlayer()
    local closest = nil
    local minDistance = Config.AimRadius
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Config.CheckTeam and player.Team == LocalPlayer.Team then continue end
        
        local char = player.Character
        if not char then continue end
        
        local humanoid = char:FindFirstChild("Humanoid")
        local rootPart = char:FindFirstChild("HumanoidRootPart")
        local targetPart = char:FindFirstChild(Config.AimPart)
        
        if humanoid and humanoid.Health > 0 and rootPart and targetPart then
            local screenPos, onScreen = Camera:WorldToScreenPoint(targetPart.Position)
            
            if onScreen then
                local mouseDist = (Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                
                if mouseDist < minDistance then
                    if IsVisible(targetPart) then
                        minDistance = mouseDist
                        closest = targetPart
                    end
                end
            end
        end
    end
    return closest
end

-- 3. ESP Логика
local function UpdateESP()
    if not Config.ESPEnabled then
        for _, obj in pairs(ESPContainer) do
            if obj.Highlight then obj.Highlight:Destroy() end
            if obj.Billboard then obj.Billboard:Destroy() end
        end
        ESPContainer = {}
        return
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            if Config.CheckTeam and player.Team == LocalPlayer.Team then 
                if ESPContainer[player] then
                    if ESPContainer[player].Highlight then ESPContainer[player].Highlight:Destroy() end
                    if ESPContainer[player].Billboard then ESPContainer[player].Billboard:Destroy() end
                    ESPContainer[player] = nil
                end
                continue 
            end

            if not ESPContainer[player] then
                ESPContainer[player] = {}
            end

            local char = player.Character
            
            -- Highlight
            if not char:FindFirstChild("WindUI_Highlight") then
                local hl = Instance.new("Highlight", char)
                hl.Name = "WindUI_Highlight"
                hl.FillTransparency = 0.5
                hl.OutlineTransparency = 0
                ESPContainer[player].Highlight = hl
            else
                local hl = char:FindFirstChild("WindUI_Highlight")
                hl.FillColor = Config.ESPFillColor
                hl.OutlineColor = Config.ESPOutlineColor
            end

            -- Names
            local head = char:FindFirstChild("Head")
            if head and Config.ESPNames then
                if not head:FindFirstChild("WindUI_NameTag") then
                    local bb = Instance.new("BillboardGui", head)
                    bb.Name = "WindUI_NameTag"
                    bb.Size = UDim2.new(0, 200, 0, 50)
                    bb.StudsOffset = Vector3.new(0, 2, 0)
                    bb.AlwaysOnTop = true
                    
                    local txt = Instance.new("TextLabel", bb)
                    txt.Size = UDim2.new(1,0,1,0)
                    txt.BackgroundTransparency = 1
                    txt.TextColor3 = Color3.white
                    txt.TextStrokeTransparency = 0
                    txt.Font = Enum.Font.GothamBold
                    txt.TextSize = 14
                    txt.Text = player.DisplayName
                    
                    ESPContainer[player].Billboard = bb
                end
            elseif head and head:FindFirstChild("WindUI_NameTag") and not Config.ESPNames then
                head.WindUI_NameTag:Destroy()
            end
        end
    end
end

-- // ИНТЕРФЕЙС (WINDUI) //

local Window = WindUI:CreateWindow({
    Title = "Legit Aim & ESP",
    Icon = "solar:shield-check-bold",
    Author = "slrNova",
    Folder = "WindAimFixed",
    Size = UDim2.fromOffset(550, 400),
    Transparent = true,
    Theme = "Dark",
    HasOutline = true
})

local CombatTab = Window:Tab({ Title = "Combat", Icon = "solar:target-bold" })
local AimSection = CombatTab:Section({ Title = "Aimbot Settings" })

AimSection:Toggle({
    Title = "Enable Aimbot",
    Default = Config.AimEnabled,
    Callback = function(Value) Config.AimEnabled = Value end
})

AimSection:Dropdown({
    Title = "Target Part",
    Multi = false,
    Required = true,
    Items = {"Head", "UpperTorso", "HumanoidRootPart"},
    Default = "Head",
    Callback = function(Value) Config.AimPart = Value end
})

local AimConfigSection = CombatTab:Section({ Title = "Configuration" })

AimConfigSection:Slider({
    Title = "FOV Radius",
    Min = 10, Max = 800, Default = Config.AimRadius, Step = 1,
    Callback = function(Value)
        Config.AimRadius = Value
        if FOVCircle then FOVCircle.Radius = Value end
    end
})

AimConfigSection:Slider({
    Title = "Smoothness",
    Min = 0, Max = 1, Default = Config.AimSmoothness, Step = 0.05,
    Callback = function(Value) Config.AimSmoothness = Value end
})

AimConfigSection:Toggle({
    Title = "Wall Check",
    Default = Config.CheckWalls,
    Callback = function(Value) Config.CheckWalls = Value end
})

local VisualsTab = Window:Tab({ Title = "Visuals", Icon = "solar:eye-bold" })
local EspSection = VisualsTab:Section({ Title = "ESP Settings" })

EspSection:Toggle({
    Title = "Enable ESP",
    Default = Config.ESPEnabled,
    Callback = function(Value) Config.ESPEnabled = Value end
})

EspSection:Toggle({
    Title = "Show Names",
    Default = Config.ESPNames,
    Callback = function(Value) Config.ESPNames = Value end
})

EspSection:ColorPicker({
    Title = "Fill Color",
    Default = Config.ESPFillColor,
    Callback = function(Value) Config.ESPFillColor = Value end
})

local FovSection = VisualsTab:Section({ Title = "FOV Circle" })

FovSection:Toggle({
    Title = "Draw FOV",
    Default = Config.FOVEnabled,
    Callback = function(Value)
        Config.FOVEnabled = Value
        if FOVCircle then FOVCircle.Visible = Value end
    end
})

local SettingsTab = Window:Tab({ Title = "Settings", Icon = "solar:settings-bold" })
SettingsTab:Section({ Title = "Script" }):Button({
    Title = "Unload Script",
    Callback = function()
        if FOVCircle then FOVCircle:Remove() end
        Window:Destroy()
        Config.ESPEnabled = false
        UpdateESP()
        script.Disabled = true 
    end
})

-- // ОБРАБОТЧИКИ (MAIN LOOPS) //

local isAiming = false

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Config.AimKey then isAiming = true end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if input.UserInputType == Config.AimKey then isAiming = false; AimTarget = nil end
end)

RunService.RenderStepped:Connect(function()
    -- Обновляем круг
    if FOVCircle then
        FOVCircle.Position = Vector2.new(Mouse.X, Mouse.Y + 36)
        FOVCircle.Visible = Config.FOVEnabled
    end
    
    -- Aimbot
    if Config.AimEnabled and isAiming then
        AimTarget = GetClosestPlayer()
        if AimTarget then
            local currentCFrame = Camera.CFrame
            local targetCFrame = CFrame.new(currentCFrame.Position, AimTarget.Position)
            local lerpFactor = 1 - Config.AimSmoothness
            if lerpFactor < 0.01 then lerpFactor = 0.01 end
            Camera.CFrame = currentCFrame:Lerp(targetCFrame, lerpFactor)
        end
    end
end)

task.spawn(function()
    while task.wait(0.5) do UpdateESP() end
end)

WindUI:Notify({
    Title = "Success",
    Content = "Script Fixed & Loaded!",
    Icon = "solar:check-circle-bold",
    Duration = 3
})
