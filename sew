local WindUI = loadstring(game:HttpGet("https://tree-hub.vercel.app/api/UI/WindUI"))()
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")
local StatsService = game:GetService("Stats")
local Lighting = game:GetService("Lighting")

local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- // НАСТРОЙКИ ПО УМОЛЧАНИЮ //
local DEFAULT_SETTINGS = {
    AIM_KEY = Enum.UserInputType.MouseButton2,
    MAX_DISTANCE = 65,
    FOV_ANGLE = 70,
    MAX_RADIUS = 200,
    PRIORITIZE_LIMBS = true,
    SHOW_RADIUS_CIRCLE = true,
    CIRCLE_TRANSPARENCY = 0.7,
    OBSTACLE_CHECK = true,
    CAMERA_FOV = 70,
    CROSSHAIR_ENABLED = true,
    SHOW_PING = true,
    SHOW_FPS = true,
    AIM_ENABLED = true,
    AIM_HEAD = true,
    AIM_TORSO = true,
    AIM_LEFT_ARM = false,
    AIM_RIGHT_ARM = false,
    AIM_LEFT_LEG = false,
    AIM_RIGHT_LEG = false,
    CROSSHAIR_COLOR_R = 255,
    CROSSHAIR_COLOR_G = 105,
    CROSSHAIR_COLOR_B = 180,
    WATERMARK_COLOR_R = 255,
    WATERMARK_COLOR_G = 105,
    WATERMARK_COLOR_B = 180,
    RADIUS_COLOR_R = 255,
    RADIUS_COLOR_G = 105,
    RADIUS_COLOR_B = 180,
    
    ESP_ENABLED = false,
    ESP_COLOR_R = 255,
    ESP_COLOR_G = 255,
    ESP_COLOR_B = 255,
    SILHOUETTE_ENABLED = false,
    SILHOUETTE_COLOR_R = 255,
    SILHOUETTE_COLOR_G = 105,
    SILHOUETTE_COLOR_B = 180,
    SILHOUETTE_TRANSPARENCY = 0.5,
    NAMES_ENABLED = false,
    TEXT_COLOR_R = 255,
    TEXT_COLOR_G = 255,
    TEXT_COLOR_B = 255,
    OUTLINE_COLOR_R = 0,
    OUTLINE_COLOR_G = 0,
    OUTLINE_COLOR_B = 0,
    TEXT_SIZE = 16,
    ESP_THROUGH_WALLS = true,
    MAX_ESP_DISTANCE = 1000,
    ESP_UPDATE_INTERVAL = 1,
    SHOW_DISPLAY_NAME = true,
    SHOW_USERNAME = true
}

local SETTINGS_FILENAME = "aimlock_settings.json"
local SETTINGS = table.clone(DEFAULT_SETTINGS)

local isAiming = false
local aimConnection = nil
local currentCrosshair = nil
local watermark = nil
local mouse = localPlayer:GetMouse()
local connections = {}
local createdObjects = {}
local me = Players.LocalPlayer

local fpsCounter = 0
local fps = 0
local respawnToggle = false
local antiLagToggle = false
-- Клавиши по умолчанию для функций (будут перезаписаны UI Keybinds)
local ANTI_LAG_KEY = Enum.KeyCode.Y 
local LOOP_RESET_KEY = Enum.KeyCode.T

-- Переменные ESP
local espEnabled = false
local silhouetteEnabled = false
local namesEnabled = false
local espThroughWalls = true
local maxEspDistance = 1000
local espUpdateInterval = 1
local lastEspUpdate = 0
local espObjects = {}
local nameTags = {}

local espSettings = {
    Color = Color3.fromRGB(255, 255, 255),
    SilhouetteColor = Color3.fromRGB(255, 105, 180),
    SilhouetteTransparency = 0.5,
    TextColor = Color3.fromRGB(255, 255, 255),
    OutlineColor = Color3.fromRGB(0, 0, 0),
    TextSize = 16,
    ShowDisplayName = true,
    ShowUsername = true
}

-- // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ЦВЕТА //
function getCrosshairColor()
    return Color3.fromRGB(SETTINGS.CROSSHAIR_COLOR_R, SETTINGS.CROSSHAIR_COLOR_G, SETTINGS.CROSSHAIR_COLOR_B)
end

function getWatermarkColor()
    return Color3.fromRGB(SETTINGS.WATERMARK_COLOR_R, SETTINGS.WATERMARK_COLOR_G, SETTINGS.WATERMARK_COLOR_B)
end

function getRadiusColor()
    return Color3.fromRGB(SETTINGS.RADIUS_COLOR_R, SETTINGS.RADIUS_COLOR_G, SETTINGS.RADIUS_COLOR_B)
end

-- // ФУНКЦИИ СОХРАНЕНИЯ/ЗАГРУЗКИ //
function saveSettings()
    local success, _ = pcall(function()
        local saveData = table.clone(SETTINGS)
        -- Обновляем данные ESP перед сохранением
        saveData.ESP_ENABLED = espEnabled
        saveData.ESP_COLOR_R = math.floor(espSettings.Color.R * 255)
        saveData.ESP_COLOR_G = math.floor(espSettings.Color.G * 255)
        saveData.ESP_COLOR_B = math.floor(espSettings.Color.B * 255)
        saveData.SILHOUETTE_ENABLED = silhouetteEnabled
        saveData.SILHOUETTE_COLOR_R = math.floor(espSettings.SilhouetteColor.R * 255)
        saveData.SILHOUETTE_COLOR_G = math.floor(espSettings.SilhouetteColor.G * 255)
        saveData.SILHOUETTE_COLOR_B = math.floor(espSettings.SilhouetteColor.B * 255)
        saveData.SILHOUETTE_TRANSPARENCY = espSettings.SilhouetteTransparency
        saveData.NAMES_ENABLED = namesEnabled
        saveData.TEXT_COLOR_R = math.floor(espSettings.TextColor.R * 255)
        saveData.TEXT_COLOR_G = math.floor(espSettings.TextColor.G * 255)
        saveData.TEXT_COLOR_B = math.floor(espSettings.TextColor.B * 255)
        saveData.OUTLINE_COLOR_R = math.floor(espSettings.OutlineColor.R * 255)
        saveData.OUTLINE_COLOR_G = math.floor(espSettings.OutlineColor.G * 255)
        saveData.OUTLINE_COLOR_B = math.floor(espSettings.OutlineColor.B * 255)
        saveData.TEXT_SIZE = espSettings.TextSize
        saveData.ESP_THROUGH_WALLS = espThroughWalls
        saveData.MAX_ESP_DISTANCE = maxEspDistance
        saveData.ESP_UPDATE_INTERVAL = espUpdateInterval
        saveData.SHOW_DISPLAY_NAME = espSettings.ShowDisplayName
        saveData.SHOW_USERNAME = espSettings.ShowUsername

        writefile(SETTINGS_FILENAME, HttpService:JSONEncode(saveData))
    end)
    return success
end

function loadSettings()
    local success, result = pcall(function()
        if not isfile(SETTINGS_FILENAME) then return nil end
        local loaded = HttpService:JSONDecode(readfile(SETTINGS_FILENAME))
        
        -- Мержим настройки
        for k, v in pairs(DEFAULT_SETTINGS) do
            SETTINGS[k] = loaded[k] or v
        end
        
        -- Применяем настройки ESP
        espEnabled = loaded.ESP_ENABLED or false
        silhouetteEnabled = loaded.SILHOUETTE_ENABLED or false
        namesEnabled = loaded.NAMES_ENABLED or false
        espThroughWalls = loaded.ESP_THROUGH_WALLS or true
        maxEspDistance = loaded.MAX_ESP_DISTANCE or 1000
        espUpdateInterval = loaded.ESP_UPDATE_INTERVAL or 1
        
        espSettings.Color = Color3.fromRGB(loaded.ESP_COLOR_R or 255, loaded.ESP_COLOR_G or 255, loaded.ESP_COLOR_B or 255)
        espSettings.SilhouetteColor = Color3.fromRGB(loaded.SILHOUETTE_COLOR_R or 255, loaded.SILHOUETTE_COLOR_G or 105, loaded.SILHOUETTE_COLOR_B or 180)
        espSettings.SilhouetteTransparency = loaded.SILHOUETTE_TRANSPARENCY or 0.5
        espSettings.TextColor = Color3.fromRGB(loaded.TEXT_COLOR_R or 255, loaded.TEXT_COLOR_G or 255, loaded.TEXT_COLOR_B or 255)
        espSettings.OutlineColor = Color3.fromRGB(loaded.OUTLINE_COLOR_R or 0, loaded.OUTLINE_COLOR_G or 0, loaded.OUTLINE_COLOR_B or 0)
        espSettings.TextSize = loaded.TEXT_SIZE or 16
        espSettings.ShowDisplayName = loaded.SHOW_DISPLAY_NAME or true
        espSettings.ShowUsername = loaded.SHOW_USERNAME or true
        
        if SETTINGS.CAMERA_FOV then camera.FieldOfView = SETTINGS.CAMERA_FOV end
        return true
    end)
    return success and result
end

-- // ЛОГИКА AIMLOCK & VISUALS (КРОССХЕЙР, WATERMARK) //
function getPing()
    local stats = StatsService:FindFirstChild("PerformanceStats")
    if stats and stats:FindFirstChild("Ping") then
        return math.floor(stats.Ping:GetValue())
    end
    return 0
end

local fpsConnection = RunService.RenderStepped:Connect(function() fpsCounter = fpsCounter + 1 end)
table.insert(connections, fpsConnection)
spawn(function() while task.wait(1) do fps = fpsCounter; fpsCounter = 0 end end)

function createWatermark()
    if watermark then watermark.Gui:Destroy() end
    local screenGui = Instance.new("ScreenGui", game.CoreGui)
    screenGui.Name = "AimlockWatermark"
    table.insert(createdObjects, screenGui)
    
    local frame = Instance.new("Frame", screenGui)
    frame.Size = UDim2.new(0, 250, 0, 35)
    frame.Position = UDim2.new(0, 10, 1, -45)
    frame.BackgroundColor3 = Color3.new(0,0,0)
    frame.BackgroundTransparency = 0.7
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)
    
    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(0, 140, 1, 0)
    label.Position = UDim2.new(0, 5, 0, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Text = "Aimlock by slrNova"
    label.Font = Enum.Font.GothamBold
    label.TextSize = 14
    label.TextXAlignment = Enum.TextXAlignment.Left
    
    watermark = { Gui = screenGui, Frame = frame, Label = label }
    updateWatermarkVisibility()
    return watermark
end

function updateWatermarkVisibility()
    if not watermark then return end
    local currentX = 145
    for _, c in ipairs(watermark.Frame:GetChildren()) do 
        if c.Name:find("Separator") or c.Name:find("Label2") then c:Destroy() end 
    end
    
    if SETTINGS.SHOW_PING then
        currentX = currentX + 20
        local ping = Instance.new("TextLabel", watermark.Frame)
        ping.Name = "PingLabel2"
        ping.Size = UDim2.new(0, 80, 1, 0)
        ping.Position = UDim2.new(0, currentX, 0, 0)
        ping.BackgroundTransparency = 1
        ping.TextColor3 = Color3.white
        ping.Font = Enum.Font.GothamBold
        ping.TextSize = 14
        ping.Text = "Ping: 0ms"
        ping.TextXAlignment = Enum.TextXAlignment.Left
        currentX = currentX + 80
    end
    
    if SETTINGS.SHOW_FPS then
        currentX = currentX + 20
        local fpsL = Instance.new("TextLabel", watermark.Frame)
        fpsL.Name = "FPSLabel2"
        fpsL.Size = UDim2.new(0, 80, 1, 0)
        fpsL.Position = UDim2.new(0, currentX, 0, 0)
        fpsL.BackgroundTransparency = 1
        fpsL.TextColor3 = Color3.white
        fpsL.Font = Enum.Font.GothamBold
        fpsL.TextSize = 14
        fpsL.Text = "FPS: 0"
        fpsL.TextXAlignment = Enum.TextXAlignment.Left
        currentX = currentX + 80
    end
    watermark.Frame.Size = UDim2.new(0, currentX - 5, 0, 35)
end

function updateWatermarkColor()
    if not watermark or not watermark.Label then createWatermark() return end
    watermark.Label.TextColor3 = isAiming and getWatermarkColor() or Color3.white
end

function removeWatermark() if watermark then watermark.Gui:Destroy(); watermark = nil end end

function createCrosshair()
    if not SETTINGS.CROSSHAIR_ENABLED then return end
    if currentCrosshair then currentCrosshair:Destroy() end
    
    local screenGui = Instance.new("ScreenGui", game.CoreGui)
    screenGui.Name = "AimlockCrosshair"
    table.insert(createdObjects, screenGui)
    
    local centerDot = Instance.new("Frame", screenGui)
    centerDot.Size = UDim2.new(0, 6, 0, 6)
    centerDot.AnchorPoint = Vector2.new(0.5, 0.5)
    centerDot.BackgroundColor3 = getCrosshairColor()
    centerDot.ZIndex = 999
    
    local dotConn = RunService.RenderStepped:Connect(function()
        if centerDot.Parent then centerDot.Position = UDim2.new(0, mouse.X, 0, mouse.Y) else dotConn:Disconnect() end
    end)
    table.insert(connections, dotConn)
    
    if SETTINGS.SHOW_RADIUS_CIRCLE then
        local circle = Instance.new("Frame", screenGui)
        circle.Size = UDim2.new(0, SETTINGS.MAX_RADIUS * 2, 0, SETTINGS.MAX_RADIUS * 2)
        circle.AnchorPoint = Vector2.new(0.5, 0.5)
        circle.BackgroundTransparency = 1
        
        local stroke = Instance.new("UIStroke", circle)
        stroke.Color = getRadiusColor()
        stroke.Thickness = 2
        stroke.Transparency = SETTINGS.CIRCLE_TRANSPARENCY
        Instance.new("UICorner", circle).CornerRadius = UDim.new(1, 0)
        
        local circConn = RunService.RenderStepped:Connect(function()
            if circle.Parent then circle.Position = UDim2.new(0, mouse.X, 0, mouse.Y) else circConn:Disconnect() end
        end)
        table.insert(connections, circConn)
    end
    currentCrosshair = screenGui
    return screenGui
end

function removeCrosshair() if currentCrosshair then currentCrosshair:Destroy(); currentCrosshair = nil end end

function updateCrosshairColors()
    if not currentCrosshair then return end
    if isAiming and SETTINGS.CROSSHAIR_ENABLED then createCrosshair() end
end

-- // ЛОГИКА AIM //
function getAngleBetween(v1, v2)
    local dot = math.clamp(v1.Unit:Dot(v2.Unit), -1, 1)
    return math.deg(math.acos(dot))
end

function hasClearLineOfSight(origin, targetPart)
    if not SETTINGS.OBSTACLE_CHECK then return true end
    local ray = RaycastParams.new()
    ray.FilterDescendantsInstances = {localPlayer.Character, targetPart.Parent}
    ray.FilterType = Enum.RaycastFilterType.Blacklist
    ray.IgnoreWater = true
    local res = Workspace:Raycast(origin, (targetPart.Position - origin), ray)
    return not res or res.Instance:IsDescendantOf(targetPart.Parent)
end

function findBestTarget()
    if not SETTINGS.AIM_ENABLED then return nil end
    local bestTarget = nil
    local mousePos = Vector2.new(mouse.X, mouse.Y)
    local rayOrigin = camera.CFrame.Position
    local validTargets = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player == localPlayer or not player.Character then continue end
        local hum = player.Character:FindFirstChild("Humanoid")
        if not hum or hum.Health <= 0 then continue end
        
        local targetParts = {}
        -- Сбор частей тела
        if SETTINGS.AIM_HEAD then table.insert(targetParts, {Part = player.Character:FindFirstChild("Head"), Priority = 2}) end
        if SETTINGS.AIM_TORSO then table.insert(targetParts, {Part = player.Character:FindFirstChild("HumanoidRootPart") or player.Character:FindFirstChild("UpperTorso"), Priority = 1}) end
        if SETTINGS.PRIORITIZE_LIMBS then
             if SETTINGS.AIM_LEFT_ARM then table.insert(targetParts, {Part = player.Character:FindFirstChild("Left Arm"), Priority = 3}) end
             if SETTINGS.AIM_RIGHT_ARM then table.insert(targetParts, {Part = player.Character:FindFirstChild("Right Arm"), Priority = 3}) end
             if SETTINGS.AIM_LEFT_LEG then table.insert(targetParts, {Part = player.Character:FindFirstChild("Left Leg"), Priority = 4}) end
             if SETTINGS.AIM_RIGHT_LEG then table.insert(targetParts, {Part = player.Character:FindFirstChild("Right Leg"), Priority = 4}) end
        end

        for _, info in ipairs(targetParts) do
            local part = info.Part
            if not part then continue end
            local pos, onScreen = camera:WorldToScreenPoint(part.Position)
            if not onScreen then continue end
            
            local distCursor = (Vector2.new(pos.X, pos.Y) - mousePos).Magnitude
            if distCursor > SETTINGS.MAX_RADIUS then continue end
            
            local dist3D = (rayOrigin - part.Position).Magnitude
            if dist3D > SETTINGS.MAX_DISTANCE then continue end
            
            table.insert(validTargets, {Part = part, DistC = distCursor, Dist3D = dist3D, Prio = info.Priority})
        end
    end
    
    if #validTargets == 0 then return nil end
    
    table.sort(validTargets, function(a, b)
        if a.DistC ~= b.DistC then return a.DistC < b.DistC end
        return a.Prio > b.Prio
    end)
    
    for _, t in ipairs(validTargets) do
        if hasClearLineOfSight(rayOrigin, t.Part) then return t end
    end
    
    return validTargets[1] -- Возврат лучшего даже если за стеной, если все за стеной
end

function aimAtTarget()
    local t = findBestTarget()
    if t then camera.CFrame = CFrame.new(camera.CFrame.Position, t.Part.Position) end
end

-- // ФУНКЦИИ ESP //
function createNameTag(player)
    if not player or player == localPlayer then return end
    if nameTags[player] then nameTags[player]:Destroy() end
    local char = player.Character
    local head = char and char:WaitForChild("Head", 1)
    if not head then return end
    
    local bb = Instance.new("BillboardGui", head)
    bb.Name = "NameTag"
    bb.Size = UDim2.new(0, 200, 0, 30)
    bb.StudsOffset = Vector3.new(0, 3, 0)
    bb.AlwaysOnTop = true
    bb.Enabled = namesEnabled
    
    local lbl = Instance.new("TextLabel", bb)
    lbl.Size = UDim2.new(1,0,1,0)
    lbl.BackgroundTransparency = 1
    lbl.Text = (espSettings.ShowDisplayName and player.DisplayName or "") .. (espSettings.ShowUsername and " (@"..player.Name..")" or "")
    lbl.TextColor3 = espSettings.TextColor
    lbl.TextSize = espSettings.TextSize
    lbl.Font = Enum.Font.GothamBold
    lbl.TextStrokeColor3 = espSettings.OutlineColor
    lbl.TextStrokeTransparency = 0.3
    
    nameTags[player] = bb
end

function createEsp(player)
    if not player or player == localPlayer then return end
    if espObjects[player] then for _, v in pairs(espObjects[player]) do v:Destroy() end end
    espObjects[player] = {}
    
    local char = player.Character
    if not char then return end
    
    if espEnabled then
        local hl = Instance.new("Highlight", char)
        hl.Name = "ESP_Highlight"
        hl.FillTransparency = 1
        hl.OutlineColor = espSettings.Color
        hl.DepthMode = espThroughWalls and Enum.HighlightDepthMode.AlwaysOnTop or Enum.HighlightDepthMode.Occluded
        table.insert(espObjects[player], hl)
    end
    
    if silhouetteEnabled then
        local hl = Instance.new("Highlight", char)
        hl.Name = "ESP_Silhouette"
        hl.FillColor = espSettings.SilhouetteColor
        hl.FillTransparency = espSettings.SilhouetteTransparency
        hl.OutlineTransparency = 1
        hl.DepthMode = espThroughWalls and Enum.HighlightDepthMode.AlwaysOnTop or Enum.HighlightDepthMode.Occluded
        table.insert(espObjects[player], hl)
    end
    
    if namesEnabled then createNameTag(player) end
end

function refreshAllEsp()
    for p, _ in pairs(espObjects) do if espObjects[p] then for _,v in pairs(espObjects[p]) do v:Destroy() end end end
    espObjects = {}
    for p, v in pairs(nameTags) do v:Destroy() end
    nameTags = {}
    for _, p in pairs(Players:GetPlayers()) do if p ~= localPlayer then createEsp(p) end end
end

-- // UI ВНЕДРЕНИЕ (WINDUI) //
local Window = WindUI:CreateWindow({
    Title = "Aimlock by slrNova",
    Icon = "solar:shield-user-bold",
    Author = "slrNova",
    Folder = "AimlockSettings",
    Size = UDim2.fromOffset(580, 460),
    Transparent = true,
    Theme = "Dark",
    SideBarWidth = 170,
    HasOutline = true,
})

-- 1. Main Tab
local MainTab = Window:Tab({ Title = "Main", Icon = "solar:home-2-bold" })
local AimSection = MainTab:Section({ Title = "Aimlock Control", Collapsible = false })

AimSection:Toggle({
    Title = "Enable Aimlock",
    Default = SETTINGS.AIM_ENABLED,
    Callback = function(Value)
        SETTINGS.AIM_ENABLED = Value
        saveSettings()
        if not Value and isAiming then
            isAiming = false
            updateWatermarkColor()
            if aimConnection then aimConnection:Disconnect() aimConnection = nil end
            removeCrosshair()
        end
    end
})

AimSection:Toggle({
    Title = "Enable Crosshair",
    Default = SETTINGS.CROSSHAIR_ENABLED,
    Callback = function(Value)
        SETTINGS.CROSSHAIR_ENABLED = Value
        if not Value then removeCrosshair() end
        saveSettings()
    end
})

local AimSetSection = MainTab:Section({ Title = "Aim Settings" })

AimSetSection:Slider({
    Title = "Aim Radius",
    Min = 50,
    Max = 500,
    Default = SETTINGS.MAX_RADIUS,
    Callback = function(Value)
        SETTINGS.MAX_RADIUS = Value
        if isAiming then createCrosshair() end
        saveSettings()
    end
})

AimSetSection:Slider({
    Title = "Max Distance",
    Min = 20,
    Max = 200,
    Default = SETTINGS.MAX_DISTANCE,
    Callback = function(Value) SETTINGS.MAX_DISTANCE = Value; saveSettings() end
})

AimSetSection:Slider({
    Title = "Camera FOV",
    Min = 1,
    Max = 120,
    Default = SETTINGS.CAMERA_FOV,
    Callback = function(Value)
        SETTINGS.CAMERA_FOV = Value
        SETTINGS.FOV_ANGLE = Value
        camera.FieldOfView = Value
        saveSettings()
    end
})

local ColorSection = MainTab:Section({ Title = "Colors" })

ColorSection:ColorPicker({
    Title = "Crosshair Color",
    Default = Color3.fromRGB(SETTINGS.CROSSHAIR_COLOR_R, SETTINGS.CROSSHAIR_COLOR_G, SETTINGS.CROSSHAIR_COLOR_B),
    Callback = function(Color)
        SETTINGS.CROSSHAIR_COLOR_R = math.floor(Color.R * 255)
        SETTINGS.CROSSHAIR_COLOR_G = math.floor(Color.G * 255)
        SETTINGS.CROSSHAIR_COLOR_B = math.floor(Color.B * 255)
        updateCrosshairColors()
        saveSettings()
    end
})

ColorSection:ColorPicker({
    Title = "Radius Color",
    Default = Color3.fromRGB(SETTINGS.RADIUS_COLOR_R, SETTINGS.RADIUS_COLOR_G, SETTINGS.RADIUS_COLOR_B),
    Callback = function(Color)
        SETTINGS.RADIUS_COLOR_R = math.floor(Color.R * 255)
        SETTINGS.RADIUS_COLOR_G = math.floor(Color.G * 255)
        SETTINGS.RADIUS_COLOR_B = math.floor(Color.B * 255)
        updateCrosshairColors()
        saveSettings()
    end
})

-- 2. Aim Parts Tab
local PartsTab = Window:Tab({ Title = "Aim Parts", Icon = "solar:target-bold" })
local TargetSection = PartsTab:Section({ Title = "Targeting Logic" })

TargetSection:Toggle({
    Title = "Prioritize Limbs",
    Default = SETTINGS.PRIORITIZE_LIMBS,
    Callback = function(v) SETTINGS.PRIORITIZE_LIMBS = v; saveSettings() end
})

TargetSection:Toggle({
    Title = "Obstacle Check",
    Default = SETTINGS.OBSTACLE_CHECK,
    Callback = function(v) SETTINGS.OBSTACLE_CHECK = v; saveSettings() end
})

local BodySection = PartsTab:Section({ Title = "Body Parts" })

BodySection:Toggle({ Title = "Head", Default = SETTINGS.AIM_HEAD, Callback = function(v) SETTINGS.AIM_HEAD = v; saveSettings() end })
BodySection:Toggle({ Title = "Torso", Default = SETTINGS.AIM_TORSO, Callback = function(v) SETTINGS.AIM_TORSO = v; saveSettings() end })
BodySection:Toggle({ Title = "Left Arm", Default = SETTINGS.AIM_LEFT_ARM, Callback = function(v) SETTINGS.AIM_LEFT_ARM = v; saveSettings() end })
BodySection:Toggle({ Title = "Right Arm", Default = SETTINGS.AIM_RIGHT_ARM, Callback = function(v) SETTINGS.AIM_RIGHT_ARM = v; saveSettings() end })
BodySection:Toggle({ Title = "Left Leg", Default = SETTINGS.AIM_LEFT_LEG, Callback = function(v) SETTINGS.AIM_LEFT_LEG = v; saveSettings() end })
BodySection:Toggle({ Title = "Right Leg", Default = SETTINGS.AIM_RIGHT_LEG, Callback = function(v) SETTINGS.AIM_RIGHT_LEG = v; saveSettings() end })

-- 3. Visuals Tab
local VisualsTab = Window:Tab({ Title = "Visuals", Icon = "solar:eye-bold" })
local EspSetSection = VisualsTab:Section({ Title = "ESP Settings" })

EspSetSection:Slider({
    Title = "Max ESP Distance",
    Min = 60,
    Max = 2500,
    Default = maxEspDistance,
    Callback = function(v) maxEspDistance = v; refreshAllEsp(); saveSettings() end
})

EspSetSection:Toggle({
    Title = "Through Walls",
    Default = espThroughWalls,
    Callback = function(v) espThroughWalls = v; refreshAllEsp(); saveSettings() end
})

local PlayerEspSection = VisualsTab:Section({ Title = "Player ESP" })

PlayerEspSection:Toggle({
    Title = "Enable ESP (Highlight)",
    Default = espEnabled,
    Callback = function(v) espEnabled = v; refreshAllEsp(); saveSettings() end
})

PlayerEspSection:ColorPicker({
    Title = "ESP Color",
    Default = espSettings.Color,
    Callback = function(c) espSettings.Color = c; refreshAllEsp(); saveSettings() end
})

PlayerEspSection:Toggle({
    Title = "Enable Fill (Silhouette)",
    Default = silhouetteEnabled,
    Callback = function(v) silhouetteEnabled = v; refreshAllEsp(); saveSettings() end
})

PlayerEspSection:ColorPicker({
    Title = "Fill Color",
    Default = espSettings.SilhouetteColor,
    Callback = function(c) espSettings.SilhouetteColor = c; refreshAllEsp(); saveSettings() end
})

PlayerEspSection:Slider({
    Title = "Fill Transparency",
    Min = 0,
    Max = 1,
    Default = espSettings.SilhouetteTransparency,
    Step = 0.1,
    Callback = function(v) espSettings.SilhouetteTransparency = v; refreshAllEsp(); saveSettings() end
})

local NameEspSection = VisualsTab:Section({ Title = "Name ESP" })

NameEspSection:Toggle({
    Title = "Show Names",
    Default = namesEnabled,
    Callback = function(v) namesEnabled = v; refreshAllEsp(); saveSettings() end
})

NameEspSection:ColorPicker({
    Title = "Text Color",
    Default = espSettings.TextColor,
    Callback = function(c) espSettings.TextColor = c; refreshAllEsp(); saveSettings() end
})

NameEspSection:Slider({
    Title = "Text Size",
    Min = 10,
    Max = 24,
    Default = espSettings.TextSize,
    Callback = function(v) espSettings.TextSize = v; refreshAllEsp(); saveSettings() end
})

-- 4. Settings Tab
local SettingsTab = Window:Tab({ Title = "Settings", Icon = "solar:settings-bold" })
local HotkeySection = SettingsTab:Section({ Title = "Controls" })

HotkeySection:Keybind({
    Title = "Anti Lag Toggle",
    Default = Enum.KeyCode.Y,
    Callback = function()
        antiLagToggle = not antiLagToggle
        local s = localPlayer.PlayerScripts:FindFirstChild("CharacterAndBeamMove")
        if s then s.Enabled = not s.Enabled end
        WindUI:Notify({ Title = "Anti Lag", Content = antiLagToggle and "Enabled" or "Disabled", Icon = "solar:bolt-bold" })
    end
})

HotkeySection:Keybind({
    Title = "Loop Reset Toggle",
    Default = Enum.KeyCode.T,
    Callback = function()
        respawnToggle = not respawnToggle
        WindUI:Notify({ Title = "Loop Reset", Content = respawnToggle and "Enabled" or "Disabled", Icon = "solar:refresh-bold" })
    end
})

local VisUiSection = SettingsTab:Section({ Title = "UI Settings" })

VisUiSection:Toggle({
    Title = "Show Radius Circle",
    Default = SETTINGS.SHOW_RADIUS_CIRCLE,
    Callback = function(v) SETTINGS.SHOW_RADIUS_CIRCLE = v; if isAiming then createCrosshair() end; saveSettings() end
})

VisUiSection:Toggle({
    Title = "Show Ping/FPS",
    Default = SETTINGS.SHOW_PING,
    Callback = function(v) SETTINGS.SHOW_PING = v; SETTINGS.SHOW_FPS = v; createWatermark(); saveSettings() end
})

local ManageSection = SettingsTab:Section({ Title = "Management" })

ManageSection:Button({
    Title = "Save Settings",
    Callback = function()
        if saveSettings() then
            WindUI:Notify({ Title = "Settings", Content = "Saved successfully!", Icon = "solar:disk-bold", Type = "Success" })
        end
    end
})

ManageSection:Button({
    Title = "Reload Settings",
    Callback = function()
        if loadSettings() then
            WindUI:Notify({ Title = "Settings", Content = "Loaded successfully!", Icon = "solar:download-bold", Type = "Success" })
            refreshAllEsp()
            createWatermark()
        end
    end
})

ManageSection:Button({
    Title = "Unload Script",
    Callback = function()
        for _, c in pairs(connections) do c:Disconnect() end
        for _, o in pairs(createdObjects) do o:Destroy() end
        refreshAllEsp() -- Clears ESP
        removeWatermark()
        removeCrosshair()
        Window:Destroy()
    end
})

-- 5. Info Tab
local InfoTab = Window:Tab({ Title = "Info", Icon = "solar:info-circle-bold" })
InfoTab:Section({ Title = "Credits" }):Paragraph({
    Title = "The Solar Triad",
    Content = "Script by slrNova\nSpecial thanks: leilahimikat, zig_pdd"
})

-- // ОБРАБОТЧИКИ СОБЫТИЙ //
local aimInputConn = UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.UserInputType == SETTINGS.AIM_KEY and SETTINGS.AIM_ENABLED then
        isAiming = true
        updateWatermarkColor()
        createCrosshair()
        aimConnection = RunService.RenderStepped:Connect(function()
            if isAiming and SETTINGS.AIM_ENABLED then aimAtTarget() end
        end)
    end
end)
table.insert(connections, aimInputConn)

local aimEndConn = UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == SETTINGS.AIM_KEY then
        isAiming = false
        updateWatermarkColor()
        if aimConnection then aimConnection:Disconnect() end
        removeCrosshair()
    end
end)
table.insert(connections, aimEndConn)

-- Петля обновления информации Watermark
local infoConn = RunService.Heartbeat:Connect(function()
    if watermark and watermark.Frame then
        local pL = watermark.Frame:FindFirstChild("PingLabel2")
        if pL then pL.Text = "Ping: "..getPing().."ms" end
        local fL = watermark.Frame:FindFirstChild("FPSLabel2")
        if fL then fL.Text = "FPS: "..fps end
    enend)
table.insert(connections, infoConn)

-- Петля обновления ESP (добавление новых игроков)
spawn(function()
    while task.wait(espUpdateInterval) do
        if espEnabled or silhouetteEnabled or namesEnabled then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= localPlayer and p.Character then createEsp(p) end
            end
        end
    end
end)

-- Инициализация при запуске
loadSettings()
createWatermark()
WindUI:Notify({
    Title = "Loaded",
    Content = "Aimlock by slrNova ready!",
    Icon = "solar:check-circle-bold",
    Duration = 5
})
