local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Perdole Suite V4",
   LoadingTitle = "Загрузка Combat-модулей...",
   LoadingSubtitle = "by Gemini",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "PerdoleScripts",
      FileName = "perdoleAIM"
   }
})

-- Настройки
local Settings = {
    Aimbot = false,
    ESP = false,
    AntiAim = false,
    AA_Type = "Spin", -- Spin или Pitch (Вниз)
    ThirdPerson = false,
    TPDist = 15,
    FOV = 150,
    TeamCheck = true
}

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--- ВИЗУАЛИЗАЦИЯ (ЛИНИЯ НАВОДКИ) ---
local AimLine = Drawing.new("Line")
AimLine.Visible = false
AimLine.Color = Color3.fromRGB(0, 255, 255) -- Бирюзовая линия
AimLine.Thickness = 1.5

--- ESP СИСТЕМА ---
local function CreateESP(player)
    local box = Drawing.new("Square")
    box.Visible = false
    box.Color = Color3.fromRGB(255, 0, 0)
    box.Thickness = 1
    
    RunService.RenderStepped:Connect(function()
        if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and Settings.ESP and player ~= LocalPlayer then
            if Settings.TeamCheck and player.Team == LocalPlayer.Team then box.Visible = false return end
            
            local pos, onScreen = Camera:WorldToViewportPoint(player.Character.HumanoidRootPart.Position)
            if onScreen then
                local size = 2000 / pos.Z
                box.Size = Vector2.new(size, size * 1.5)
                box.Position = Vector2.new(pos.X - box.Size.X / 2, pos.Y - box.Size.Y / 2)
                box.Visible = true
            else
                box.Visible = false
            end
        else
            box.Visible = false
        end
    end)
end

for _, p in pairs(Players:GetPlayers()) do CreateESP(p) end
Players.PlayerAdded:Connect(CreateESP)

--- ФУНКЦИЯ ПОИСКА БЛИЖАЙШЕГО ---
local function GetClosest()
    local target = nil
    local dist = Settings.FOV
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            if Settings.TeamCheck and p.Team == LocalPlayer.Team then continue end
            
            local pos, onScreen = Camera:WorldToViewportPoint(p.Character.HumanoidRootPart.Position)
            if onScreen then
                local mag = (Vector2.new(pos.X, pos.Y) - Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)).Magnitude
                if mag < dist then
                    -- Проверка стен
                    local ray = Ray.new(Camera.CFrame.Position, (p.Character.HumanoidRootPart.Position - Camera.CFrame.Position).Unit * 500)
                    local hit = workspace:FindPartOnRayWithIgnoreList(ray, {LocalPlayer.Character, p.Character})
                    if not hit then
                        target = p
                        dist = mag
                    end
                end
            end
        end
    end
    return target
end

--- ЦИКЛ ОБРАБОТКИ ---
RunService.RenderStepped:Connect(function()
    -- 1. Третье лицо
    if Settings.ThirdPerson then
        LocalPlayer.CameraMaxZoomDistance = Settings.TPDist
        LocalPlayer.CameraMinZoomDistance = Settings.TPDist
    else
        LocalPlayer.CameraMaxZoomDistance = 128
        LocalPlayer.CameraMinZoomDistance = 0.5
    end

    -- 2. Anti-Aim
    if Settings.AntiAim and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = LocalPlayer.Character.HumanoidRootPart
        if Settings.AA_Type == "Spin" then
            hrp.CFrame = hrp.CFrame * CFrame.Angles(0, math.rad(45), 0)
        elseif Settings.AA_Type == "Down" then
            hrp.CFrame = hrp.CFrame * CFrame.Angles(math.rad(-80), 0, 0)
        end
    end

    -- 3. Визуализация Silent Aim (Линия к цели)
    local target = GetClosest()
    if Settings.Aimbot and target then
        local tPos, onScreen = Camera:WorldToViewportPoint(target.Character.HumanoidRootPart.Position)
        if onScreen then
            AimLine.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
            AimLine.To = Vector2.new(tPos.X, tPos.Y)
            AimLine.Visible = true
        else
            AimLine.Visible = false
        end
    else
        AimLine.Visible = false
    end
end)

--- МЕНЮ ---
local CombatTab = Window:CreateTab("Combat", 4483362458)
local VisualsTab = Window:CreateTab("Visuals", 4483345998)

-- Вкладка Боя
CombatTab:CreateSection("Aimbot")
CombatTab:CreateToggle({
   Name = "Silent Aimbot",
   CurrentValue = false,
   Flag = "aim_en",
   Callback = function(v) Settings.Aimbot = v end,
})

CombatTab:CreateKeybind({
   Name = "Бинд на Аимбот",
   CurrentKeybind = "F",
   Flag = "aim_kb",
   Callback = function() Settings.Aimbot = not Settings.Aimbot end,
})

CombatTab:CreateSlider({
   Name = "FOV (Радиус)",
   Range = {50, 800},
   Increment = 10,
   CurrentValue = 150,
   Flag = "aim_fov",
   Callback = function(v) Settings.FOV = v end,
})

CombatTab:CreateSection("Anti-Aim")
CombatTab:CreateToggle({
   Name = "Включить Anti-Aim",
   CurrentValue = false,
   Flag = "aa_en",
   Callback = function(v) Settings.AntiAim = v end,
})

CombatTab:CreateDropdown({
   Name = "Тип Anti-Aim",
   Options = {"Spin", "Down"},
   CurrentOption = "Spin",
   Flag = "aa_type",
   Callback = function(v) Settings.AA_Type = v[1] end,
})

-- Вкладка Визуалов
VisualsTab:CreateToggle({
   Name = "ESP (Квадраты)",
   CurrentValue = false,
   Flag = "esp_en",
   Callback = function(v) Settings.ESP = v end,
})

VisualsTab:CreateToggle({
   Name = "Третье лицо",
   CurrentValue = false,
   Flag = "tp_en",
   Callback = function(v) Settings.ThirdPerson = v end,
})

VisualsTab:CreateSlider({
   Name = "Дистанция камеры",
   Range = {5, 50},
   Increment = 1,
   CurrentValue = 15,
   Flag = "tp_dist",
   Callback = function(v) Settings.TPDist = v end,
})

Rayfield:LoadConfiguration()
