-- // СЕРВИСЫ //
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Camera = Workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- // БИБЛИОТЕКА WINDUI //
local WindUI = loadstring(game:HttpGet("https://tree-hub.vercel.app/api/UI/WindUI"))()

-- // НАСТРОЙКИ (CONFIG) //
local Config = {
    -- Aimbot
    AimEnabled = false,
    AimKey = Enum.UserInputType.MouseButton2, -- ПКМ по умолчанию
    AimPart = "Head",
    AimRadius = 150,
    AimSmoothness = 0.5, -- 0 = моментально, 1 = очень медленно
    CheckWalls = true,
    CheckTeam = true,
    
    -- Visuals
    FOVEnabled = true,
    FOVColor = Color3.fromRGB(255, 255, 255),
    
    ESPEnabled = false,
    ESPFillColor = Color3.fromRGB(255, 0, 0),
    ESPOutlineColor = Color3.fromRGB(255, 255, 255),
    ESPNames = false
}

-- // ПЕРЕМЕННЫЕ ЛОГИКИ //
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 1.5
FOVCircle.NumSides = 60
FOVCircle.Filled = false
FOVCircle.Transparency = 1

local AimTarget = nil
local ESPContainer = {} -- Хранение объектов ESP

-- // ФУНКЦИИ ЛОГИКИ //

-- 1. Проверка видимости (Стены)
local function IsVisible(targetPart)
    if not Config.CheckWalls then return true end
    local origin = Camera.CFrame.Position
    local direction = targetPart.Position - origin
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, targetPart.Parent}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    rayParams.IgnoreWater = true

    local result = Workspace:Raycast(origin, direction, rayParams)
    return result == nil -- Если луч ни во что не врезался, значит путь чист
end

-- 2. Поиск цели
local function GetClosestPlayer()
    local closest = nil
    local minDistance = Config.AimRadius
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if Config.CheckTeam and player.Team == LocalPlayer.Team then continue end
        
        local char = player.Character
        if not char then continue end
        
        local humanoid = char:FindFirstChild("Humanoid")
        local rootPart = char:FindFirstChild("HumanoidRootPart")
        local targetPart = char:FindFirstChild(Config.AimPart)
        
        if humanoid and humanoid.Health > 0 and rootPart and targetPart then
            local screenPos, onScreen = Camera:WorldToScreenPoint(targetPart.Position)
            
            if onScreen then
                local mouseDist = (Vector2.new(Mouse.X, Mouse.Y) - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                
                if mouseDist < minDistance then
                    if IsVisible(targetPart) then
                        minDistance = mouseDist
                        closest = targetPart
                    end
                end
            end
        end
    end
    return closest
end

-- 3. ESP Логика
local function UpdateESP()
    -- Очистка старых, если ESP выключен
    if not Config.ESPEnabled then
        for _, obj in pairs(ESPContainer) do
            if obj.Highlight then obj.Highlight:Destroy() end
            if obj.Billboard then obj.Billboard:Destroy() end
        end
        ESPContainer = {}
        return
    end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Проверка команды
            if Config.CheckTeam and player.Team == LocalPlayer.Team then 
                -- Если товарищ по команде, удаляем ESP если есть
                if ESPContainer[player] then
                    if ESPContainer[player].Highlight then ESPContainer[player].Highlight:Destroy() end
                    if ESPContainer[player].Billboard then ESPContainer[player].Billboard:Destroy() end
                    ESPContainer[player] = nil
                end
                continue 
            end

            -- Создание контейнера если нет
            if not ESPContainer[player] then
                ESPContainer[player] = {}
            end

            -- Highlight (Обводка)
            local char = player.Character
            if not char:FindFirstChild("WindUI_Highlight") then
                local hl = Instance.new("Highlight", char)
                hl.Name = "WindUI_Highlight"
                hl.FillTransparency = 0.5
                hl.OutlineTransparency = 0
                ESPContainer[player].Highlight = hl
            else
                -- Обновление цветов
                local hl = char:FindFirstChild("WindUI_Highlight")
                hl.FillColor = Config.ESPFillColor
                hl.OutlineColor = Config.ESPOutlineColor
            end

            -- Имена (BillboardGui)
            local head = char:FindFirstChild("Head")
            if head and Config.ESPNames then
                if not head:FindFirstChild("WindUI_NameTag") then
                    local bb = Instance.new("BillboardGui", head)
                    bb.Name = "WindUI_NameTag"
                    bb.Size = UDim2.new(0, 200, 0, 50)
                    bb.StudsOffset = Vector3.new(0, 2, 0)
                    bb.AlwaysOnTop = true
                    
                    local txt = Instance.new("TextLabel", bb)
                    txt.Size = UDim2.new(1,0,1,0)
                    txt.BackgroundTransparency = 1
                    txt.TextColor3 = Color3.white
                    txt.TextStrokeTransparency = 0
                    txt.Font = Enum.Font.GothamBold
                    txt.TextSize = 14
                    txt.Text = player.DisplayName
                    
                    ESPContainer[player].Billboard = bb
                end
            elseif head and head:FindFirstChild("WindUI_NameTag") and not Config.ESPNames then
                head.WindUI_NameTag:Destroy()
            end
        end
    end
end

-- // СОЗДАНИЕ UI //

local Window = WindUI:CreateWindow({
    Title = "Legit Aim & ESP",
    Icon = "solar:shield-check-bold", -- Иконка щита
    Author = "slrNova",
    Folder = "WindAimV2",
    Size = UDim2.fromOffset(550, 400),
    Transparent = true,
    Theme = "Dark",
    HasOutline = true
})

-- == TAB 1: COMBAT ==
local CombatTab = Window:Tab({
    Title = "Combat",
    Icon = "solar:target-bold"
})

local AimSection = CombatTab:Section({ Title = "Aimbot Settings" })

AimSection:Toggle({
    Title = "Enable Aimbot",
    Default = Config.AimEnabled,
    Callback = function(Value)
        Config.AimEnabled = Value
    end
})

AimSection:Keybind({
    Title = "Aim Key",
    Default = Enum.UserInputType.MouseButton2,
    Callback = function()
        -- WindUI сам обрабатывает бинд, нам нужно лишь ловить InputBegan ниже
    end,
    ChangedCallback = function(NewKey)
        Config.AimKey = NewKey
    end
})

AimSection:Dropdown({
    Title = "Target Part",
    Multi = false,
    Required = true,
    Items = {"Head", "UpperTorso", "HumanoidRootPart"},
    Default = "Head",
    Callback = function(Value)
        Config.AimPart = Value
    end
})

local AimConfigSection = CombatTab:Section({ Title = "Configuration" })

AimConfigSection:Slider({
    Title = "FOV Radius",
    Min = 10,
    Max = 800,
    Default = Config.AimRadius,
    Step = 1,
    Callback = function(Value)
        Config.AimRadius = Value
        FOVCircle.Radius = Value
    end
})

AimConfigSection:Slider({
    Title = "Smoothness",
    Min = 0,
    Max = 1,
    Default = Config.AimSmoothness,
    Step = 0.05,
    Callback = function(Value)
        Config.AimSmoothness = Value
    end
})

AimConfigSection:Toggle({
    Title = "Wall Check",
    Default = Config.CheckWalls,
    Callback = function(Value)
        Config.CheckWalls = Value
    end
})

AimConfigSection:Toggle({
    Title = "Team Check",
    Default = Config.CheckTeam,
    Callback = function(Value)
        Config.CheckTeam = Value
    end
})

-- == TAB 2: VISUALS ==
local VisualsTab = Window:Tab({
    Title = "Visuals",
    Icon = "solar:eye-bold"
})

local EspSection = VisualsTab:Section({ Title = "ESP Players" })

EspSection:Toggle({
    Title = "Enable ESP",
    Default = Config.ESPEnabled,
    Callback = function(Value)
        Config.ESPEnabled = Value
    end
})

EspSection:Toggle({
    Title = "Show Names",
    Default = Config.ESPNames,
    Callback = function(Value)
        Config.ESPNames = Value
    end
})

EspSection:ColorPicker({
    Title = "Fill Color",
    Default = Config.ESPFillColor,
    Callback = function(Value)
        Config.ESPFillColor = Value
    end
})

EspSection:ColorPicker({
    Title = "Outline Color",
    Default = Config.ESPOutlineColor,
    Callback = function(Value)
        Config.ESPOutlineColor = Value
    end
})

local FovSection = VisualsTab:Section({ Title = "FOV Circle" })

FovSection:Toggle({
    Title = "Draw FOV",
    Default = Config.FOVEnabled,
    Callback = function(Value)
        Config.FOVEnabled = Value
        FOVCircle.Visible = Value
    end
})

FovSection:ColorPicker({
    Title = "Circle Color",
    Default = Config.FOVColor,
    Callback = function(Value)
        Config.FOVColor = Value
        FOVCircle.Color = Value
    end
})

-- == TAB 3: SETTINGS ==
local SettingsTab = Window:Tab({
    Title = "Settings",
    Icon = "solar:settings-bold"
})

SettingsTab:Section({ Title = "Script" }):Button({
    Title = "Unload Script",
    Callback = function()
        FOVCircle:Remove()
        Window:Destroy() -- Закрытие UI
        -- Очистка ESP
        Config.ESPEnabled = false
        UpdateESP()
        -- Отключение скрипта (перезагрузкой стейта)
        script.Disabled = true 
    end
})

-- // MAIN LOOPS (ГЛАВНЫЕ ЦИКЛЫ) //

-- 1. Обработка ввода (Aim Key)
local isAiming = false

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.UserInputType == Config.AimKey or input.KeyCode == Config.AimKey then
        isAiming = true
    end
end)

UserInputService.InputEnded:Connect(function(input, gpe)
    if input.UserInputType == Config.AimKey or input.KeyCode == Config.AimKey then
        isAiming = false
        AimTarget = nil
    end
end)

-- 2. RenderStepped (Отрисовка и Aim)
RunService.RenderStepped:Connect(function()
    -- Обновление круга FOV
    FOVCircle.Position = Vector2.new(Mouse.X, Mouse.Y + 36) -- +36 компенсирует TopBar
    FOVCircle.Visible = Config.FOVEnabled
    
    -- Aimbot Логика
    if Config.AimEnabled and isAiming then
        AimTarget = GetClosestPlayer()
        if AimTarget then
            -- Вычисляем новую позицию камеры
            local currentCFrame = Camera.CFrame
            local targetCFrame = CFrame.new(currentCFrame.Position, AimTarget.Position)
            
            -- Интерполяция (Lerp) для плавности
            -- 1 - Smoothness делает так: если Smoothness 1 -> factor 0 (нет движения), если 0 -> factor 1 (моментально)
            local lerpFactor = 1 - Config.AimSmoothness
            if lerpFactor < 0.01 then lerpFactor = 0.01 end
            
            Camera.CFrame = currentCFrame:Lerp(targetCFrame, lerpFactor)
        end
    end
end)

-- 3. Цикл обновления ESP (раз в 0.5 сек для оптимизации)
task.spawn(function()
    while task.wait(0.5) do
        UpdateESP()
    end
end)

-- Финальное уведомление
WindUI:Notify({
    Title = "Script Loaded",
    Content = "Clean Aimlock has been loaded successfully.",
    Icon = "solar:check-circle-bold",
    Duration = 4.5
})
